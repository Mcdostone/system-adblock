\documentclass[a4paper,11pt, oneside]{book}
\usepackage[utf8]{inputenc}
\usepackage[francais]{babel}
\usepackage[T1]{fontenc}
\usepackage{graphicx}
\usepackage{float}
\usepackage{wrapfig}
\usepackage{setspace}
\usepackage{geometry}
\usepackage{hyperref}
\usepackage{multicol}
\usepackage{etoolbox}
\usepackage{color}
\usepackage[explicit,pagestyles]{titlesec}
\usepackage[absolute,overlay]{textpos}
\usepackage{fancyhdr}
\usepackage{fontspec}
\usepackage{eurosym}
\usepackage{titlesec}
\usepackage[]{algorithm2e}


% ====== CONFIG ========

%\setmainfont{Roboto Light}

%\setmainfont{Roboto Light}
%\setsansfont{Roboto}
%\setmonofont{Roboto}
%\newfontfamily\light{Roboto Slab Light}
\graphicspath{{img/}}
\setlength{\unitlength}{1mm}
\makeatletter

\definecolor{primary}{RGB}{44, 62, 80}


\titleformat{\chapter}[display]{\huge}{\thechapter \quad #1}{0pt}{}
\titlespacing{\chapter}{0pt}{0pt}{0pt}

\titleformat{\section}[display]{\LARGE}{}{0pt}{\thesection \quad #1}


\setlength{\TPHorizModule}{1mm}
\setlength{\TPVertModule}{1mm}
\def\sizeMedia{38}
\def\size{3.8cm}
\def\sizeMargin{0.2cm}
\def\margin{2}
\def\fixMargin{0}

\pagestyle{plain}

\author{Yann Prono, Quentin Tardivon}
\date{\today}

\def\school{TELECOM Nancy}
\def\schoolAddress{193 Avenue Paul Muller}
\def\schoolPostalCode{54602}
\def\schoolCity{Villers-lès-Nancy}
\def\schoolCodeAndCity{\schoolPostalCode, \schoolCity}
\def\schoolYear{2016 - 2017}

\def\appName{MyAdblock}
\def\widthImage{1}
\def\todo{{\color{red}\Huge{TODO}}}

\def\schoolYear{2016 - 2017}

% ====== END CONFIG ========


\begin{document}

	\begin{titlepage}
		\input{cover}
	\end{titlepage}


	\newpage\newpage\null\thispagestyle{empty}
	\newpage
		\tableofcontents
		\thispagestyle{empty}


	\chapter{Introduction}
	\setcounter{page}{1}

		La publicité sur internet est un moyen simple de gagner de l'argent.
		Celles-ci sont intégrés au sein même du site web (vidéos, bannières publicitaires...). L'abondance de contenus publicitaires apportent
		cependant quelques désavantages: L'utilisateur peut être distrait par ces publicités, la lecture du site web est plus difficile
		étant donnée la quantité d'information et l'affichage de ces publicités demandent plus de bande passante
		ainsi que de ressources pour le navigateur web.Il existe cependant des logiciels permettant de supprimer
		ces publicités. Ces logiciels vont analyser le flux entrant et sortant du navigateur afin de filtrer le contenu publicitaire.\\

		\noindent Dans le cadre de ce projet, nous devons développer un proxy ayant la même fonctionnaalité qu'un bloqueur de publicités.
		Ce proxy sera programmé en langage C à l'aide des sockets vu durant les cours.


	\chapter{Analyse}

		Afin de comprendre comment il est possible de filtrer les publicités, il est nécéssaire de comprendre fonctionne un navigateur web.
		On dispose de :
		\begin{itemize}
			\item Un navigateur web (le choix a peu d'importance dans le cadre de ce projet)
			\item Wireshark, un logiciel permettant capturer les paquets entrants et sortants de la machine\\
		\end{itemize}
		\noindent L'analyse des échanges TCP et HTTP se fera sur le site
		\href{http://www.telecomnancy.univ-lorraine.fr}{http://www.telecomnancy.univ-lorraine.fr}.
		Le site \href{http://www.01net.com}{http://www.01net.com} quant à lui sera utilisé pour
		analyser et tester le filtrage de publicités (abondance de publicités et la communication avec ce site n'est pas chiffrée).


		\section{Analyse du site telecomnancy.univ-lorraine.fr}

		Lorsque l'on souhaite accéder au site \href{http://www.telecomnancy.univ-lorraine.fr}{http://www.telecomnancy.univ-lorraine.fr} (on suppose que l'on dispose de l'adresse
		IP du serveur), des requêtes TCP (12, 13 et 14) sont envoyés au serveur afin d'initialiser la phase de connexion
		Suite à cela, une requête HTTP (15) de type \textit{GET} est envoyée au serveur afin de le contenu HTML du site web. La réponse du serveur est
		obtenu au paquet 29. Le contenu HTML est alors affiché dans le navigateur:

		\begin{figure} [htbp]
			\centering
			\includegraphics[width=\widthImage\textwidth]{1.png}\\
			\caption{Echanges de paquets au début de la communication}
		\end{figure}

		\noindent Cependant, le contenu HTML dépend d'autres ressources. Il est donc nécéssaire
		récupérer les différentes ressources (images, fichiers CSS, fichiers JS). De nouvelles requêtes sont alors envoyées (35, 38, 41...):

		\begin{figure} [htbp]
			\centering
			\includegraphics[width=\widthImage\textwidth]{2.png}\\
			\caption{Nouvelles requêtes émises suite à la réception du contenu HTML}
		\end{figure}

		On peut également retrouver l'ensemble de ces requêtes dans l'outil de développement integré dans les navigateurs web:

		\begin{figure} [htbp]
			\centering
			\includegraphics[width=\widthImage\textwidth]{3.png}\\
			\caption{Requêtes HTTP effectuées par le navigateur web}
		\end{figure}


	\clearpage
	\section{Analyse du site 01net.com}
		Le site contient de nombreux contenus publicitaires. Voici quelques requêtes permettant
		de faire une hypothese sur l'algorithme à développer:

		\begin{figure} [htbp]
			\centering
			\includegraphics[width=\widthImage\textwidth]{4.png}\\
			\caption{Requêtes HTTP pour la demande de publicités}
		\end{figure}

		Des requêtes sont faites afin de demander des ressources utiles au bon fonctionnement du site (62 pour le style avec Bootstrap twitter, 63 pour JQuery).
		D'autres sont faites afin de charger les publicités sur le site: requête 69, 75 et 79.
		Si on s'intéresse à ces trois requêtes précédentes, on peut remarquer plusieurs caractéristiques:
		\begin{itemize}
			\item Les requêtes peuvent faire appel à une ressource directement chez un service tiers: pour la requête 79,
			on a dans la requête HTTP le champ  \textit{Host: c.amazon-adsystem.com}.
			\item la réponse à une requête peut rediriger vers une autre URL disponible sur un autre serveur:
			on a dans la réponse HTTP de la requête 75 le champ \textit{Location: http://ak-ns.sascdn.com/diff/js/smart.js}, cela
			signifie que le navigateur devra faire une nouvelle requête à l'adresse indique dans le champ \textit{Location}.
			\item ....
		\end{itemize}

		\clearpage
		On peut donc en déduire l'algorithme à utiliser afin de bloquer les publicités:\\

		\begin{algorithm}[H]
			\KwData{
				\begin{itemize}
					\item req: Requête du navigateur web à traiter
					\item blacklist: Liste des URL à rejeter
				\end{itemize}
			}
			\eIf{req.Host appartient à blacklist}{
				rejeter la requête;\\
				Signaler le navigateur web du rejet de la requête;
   		}
			{
				Envoyer la requête au serveur;\\
				Attendre la réponse;\\
				Envoyer la réponse au navigateur web;
			}
		\end{algorithm}


		\chapter{Développement}

			Afin de réalisé \appName, nous nous sommes fortement inspirés du schéma présent sur le sujet.
			Notre proxy dispose de trois parties:
			\begin{itemize}
				\item La socket \textbf{server}
				\item La socket \textbf{dialog}
				\item La socket \textbf{client}
			\end{itemize}

			Chaque partie est détaillé dans la suite de ce document.


		\section{Socket server}

			La socket \textbf{server} est le point d'entrée du proxy. Au lancement du programme \appName,
			il sera nécéssaire de configurer le navigateur web afin qu'il utilise comme proxy le serveur du programme.
			Dans le cadre de notre projet, le serveur fonctionne en local sur la machine. L'adresse IP est donc \textit{127.0.0.1}. Le port
			a utiliser peut être précisé par l'utilisateur, sinon le programme choisit un port disponible.

			Cette partie du programme est représenté par le fichier \textbf{server.c}. La structure \textit{server} réunit toutes les informations
			afin de mettre la socket. Après l'appel des fonctions bind() et listen, il est nécéssaire
			d'appeler \textit{accept\_server(...)}. Cette fonction accepte toutes communications se connectant sur le serveur
			et initialise la socket de dialogue afin de traiter la requête HTTP.


		\section{Socket dialog}

			La socket \textbf{dialog} est utilisée afin de communiquer entre le navigateur web et le proxy. Cette socket est créée
			suite à la methode \textit{accept()} sur la socket du serveur. Cette socket est représentée par le fichier \textbf{dialog.c}.
			\todo

		\section{Socket client}

			La socket \textbf{client} permet de communiquer avec un serveur web. Le client va se connecter au serveur ciblé grâce à son adresse IP
			et envoyer la requête HTTP du navigateur web. La réponse est ensuite renvoyé au client qui lui la transmettras à la socket de dialogue.
			\todo

		\section{Problèmes rencontrées}

			Au cours du développement, nous avons rencontrées plusieurs difficultées.
			Premièrement, l'utilisation du langage C a été un frein important notamment pour tout ce qui est
			manipulation de chaînes de caractère.
			Le filtrage des publicités repose principalement sur la recherche de chaînes de caractères dans le header HTTP des requêtes.\\

			\noindent Nous avons rencontrés des difficultées au tout début du développement.
			La première version du programme devait simplement transmettre les requêtes au serveurs ciblées sans aucun filtre.
			Cependant, le proxy ne fonctionnait pas sur certains sites notamment \href{http://www.01net.com}{www.01net.com}.
			En analysant les headers HTTP émises par le navigateur web, nous avons porté attention sur le champ
			\textit{Connection: keep-alive}. Cette valeur signifie que le navigateur doit garder ouvert la connection (la socket) ouverte
			pour les futures requêtes. Or dans le cas de notre proxy, si une socket traite une requête donnée, elle ne peut
			pas traiter les autres requêtes qui arrivent en même temps. Par conséquent, celles arrivant durant le traitement sont perdus par
			le proxy. Afin de contourner ce problème,
			nous avons décidé de réécrire le header HTTP pour chaque requête. Cette réécriture
			modifie uniquement la valeur du champ \textit{Connection} en le mettant à la valeur \textit{close}.
			Cette valeur à pour effet de fermer la connection lorsque la réponse est envoyée au navigateur. Cela permet
			également de créer une socket pour chaque requête faite par le navigateur, évitant de perdre des requêtes HTTP.


			\chapter{Conclusion}


			\chapter{Bibliographie}
			\begin{itemize}
				\item \textit{Hypertext Transfer Protocol}, Wikipedia, \\\href{https://en.wikipedia.org/wiki/Hypertext\_Transfer\_Protocol}
				{wikipedia.org/wiki/Hypertext\_Transfer\_Protocol}, consulté le 20 avril 2017

				\item \textit{HTTP persistent connection}, Wikipedia, \\\href{https://en.wikipedia.org/wiki/HTTP\_persistent\_connection}
				{wikipedia.org/wiki/HTTP\_persistent\_connection}, consulté le 15 avril 2017

				\item \textit{Créer des filtres Adblock Plus}, Adblock Plus, \href{https://adblockplus.org/fr/filters}{adblockplus.org/fr/filters}, consulté le 16 avril 2017
				\item easylist, \href{https://easylist.to/}{easylist.to}, consulté le 10 avril 2017
			\end{itemize}


\end{document}
